<!DOCTYPE html>
{{extend 'layout.html'}}

{{block head}}
<script src="{{=URL('static', 'js/vue.js')}}"></script>
<script>
	{{if auth.user is None:}}
        var logged_in = false;
    {{else:}}
        var logged_in = true;
    {{pass}}
	//api functions for chat box
	var new_box   = "{{=URL('api', 'add_textBox',   user_signature=True)}}";
	var edit_box  = "{{=URL('api', 'edit_textBox',  user_signature=True)}}";
	var get_box   = "{{=URL('api', 'get_textBox',   user_signature=True)}}";
	var get_Title = "{{=URL('api', 'get_textTitle', user_signature=True)}}";
	var del_box   = "{{=URL('api', 'del_textBox',   user_signature=True)}}";
  	//api functions for queue
	var insert_queue      = "{{=URL('api', 'insert_queue',      user_signature=True)}}";
	var get_list_of_queue = "{{=URL('api', 'get_list_of_queue', user_signature=True)}}";
	var remove_queue      = "{{=URL('api', 'remove_queue',      user_signature=True)}}";
	var match_users       = "{{=URL('api', 'match_users',       user_signature=True)}}";
	var countdown         = "{{=URL('api', 'countdown',         user_signature=True)}}";
	//username functions
	var send_username = "{{=URL('api', 'put_username')}}";
	var get_username_url = "{{=URL('api', 'get_username')}}";
	var get_duplicates = "{{=URL('api', 'duplicate')}}";
</script>
{{end}}

<!--... makes sure that if user closes tab, they are removed from queue.
	DOES NOT WORK ON FIREFOX IF USER CLOSES WINDOW -->
<!--<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />
<body onbeforeunload="console.log('a');
	$.post(remove_queue);">-->
<div class="main_content">

	<div id="vue-div" class="display:none">
		<div v-if="logged_in">
			<div v-if="has_username == true">
				<input v-model="username" type="text">
				<button v-on:click="set_username()"> Set Username </button>
					
			</div>
		</div>

<!--.................................................. Buttons to alternate btwn random chat and group chat .................................-->
		<button v-on:click="if(!isRandom){
			  	    	insertQueue();
				    }
				    isRandom = true;
				    currentChat = null;"> random Chat  </button>

		<button v-on:click="if(isRandom){
				    	removeQueue();
				    }
				    getTitle();
				    isRandom =    false;
				    listChats =   [];
				    currentChat = null;
				    isServer    = false;"> chat Servers </button>

<!--................................................... Code to Display Random chat ..........................................................-->
		
		<div v-if="isRandom">
			{{if auth.user:}}
		
			<!-- displays if user is still searching for someone to chat with -->
			<div v-if="!isChatting">
				Searching${searchingForChat}
			</div>

			<!-- displays chat for every user you have talked to in one session -->
			<div v-if="currentChat!=null">
				
				<div v-if="isChatting">
					You have ${time} seconds left
				</div>
				<div v-for="chats in listChats" v-if="chats != null"> 
					
					<b> ${chats.chat[0]}</b> <br>
					<div v-for="line in chats.chatter.length">
						${chats.chatter[line-1]}: ${chats.chat[line]}
							
					
					</div>
				</div>
			
				<button v-if="isChatting" v-on:click="editChat(serverId);
						    		      editChat(randomBox);">Send</button>
				<textarea type="text" v-if="isChatting" placeholder="send" v-model="newChatting" 
					  ></textarea>


			</div>
			{{else:}}
			You must first be logged in to join the random chat
			{{pass}}
		</div>

<!--................................................... Code to Display group chat tab .......................................................-->
		<div v-if="!isRandom">
			<div v-if="currentChat == null || currentChat == [] || !isServer">

				<!-- code used to make a new chat room-->
				<button v-on:click="if(newTitle == '' || newTitle == null){
							alert('your Title cannot be empty. Please try again');
						    }
						    else{
						    	makeNewChat(true);
						    }
						    refresh();">  Add </button>
				<textarea type="text" placeholder="Title" v-model="newTitle"></textarea>



				<br><br>
				Chats Active
				<br><br>

				<!-- code for serach bar for chat Titles -->
				<textarea type="text" placeholder="Search for Chat" v-model="searching"></textarea>
			
				<!-- code to display a list of chat Titles -->
				<div v-for="chat in chats">

					<!-- if statement checks if the chat is being searched for -->
					<div v-if="searching == null       ||
						   searching == ''         ||
						   chat.Title == searching ||
						  (chat.Title.length > searching.length && 
						   chat.Title.substring(0,searching.length) == searching)">

						<!-- if this button is clicked, then user is redirected to the chat -->
						<button v-on:click="serverId = chat.id;
								    getChat();
								    isServer = true;
								    searching = null;">Join</button>
						<button v-on:click="delChat(chat.id);">Delete</button>
	
	
						<b>${chat.Title}</b> 
						<br>
					</div>
				</div>
			</div>
	
			<!--........... Code to display a chat box when user joins a chat ..........-->
			<div v-if="currentChat != null && isServer">
				${currentChat.Title}
	
				<!-- displaying the message for the chat box -->
				<div v-for="line in (currentChat.chat.length)">
					<b>${currentChat.chatter[line-1]}</b>: ${currentChat.chat[line-1]}
				</div>
	
				<!-- the sending part of the chat box -->
				<button v-on:click="editChat(currentChat.id);"> Send </button>
				<button v-on:click="getTitle();
						    isServer    = false;
						    currentChat = null;
						    serverId    = null;"> Exit </button>
	
				<textarea type="text" placeholder="Send" v-model="newChatting"></textarea>
	
			</div>
		</div>
	</div>
</div>

<script src="{{=URL('static', 'js/default_index.js')}}"></script>